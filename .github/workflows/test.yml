name: XDB Basic Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpass
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: å®‰è£…ä¾èµ–
      run: pip install pandas openpyxl pymysql tqdm psutil chardet

    - name: åˆ›å»ºæµ‹è¯•æ•°æ®
      run: |
        # åˆ›å»ºCSVæµ‹è¯•æ–‡ä»¶
        cat > test_data.csv << 'EOF'
        id,name,age,salary,hire_date,active
        1,å¼ ä¸‰,25,5500.50,2023-01-15,true
        2,æå››,30,7200.75,2022-05-20,false
        3,ç‹äº”,28,6800.00,2023-03-10,true
        4,èµµå…­,35,9500.25,2021-12-01,false
        EOF
        
        # åˆ›å»ºExcelæµ‹è¯•æ–‡ä»¶
        python -c "
        import openpyxl
        from datetime import date
        
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = 'æµ‹è¯•æ•°æ®'
        
        # æ ‡é¢˜è¡Œ
        headers = ['ID', 'å§“å', 'å¹´é¾„', 'å·¥èµ„', 'å…¥èŒæ—¥æœŸ', 'æ˜¯å¦åœ¨èŒ']
        for col, header in enumerate(headers, 1):
            ws.cell(row=1, column=col, value=header)
        
        # æ•°æ®è¡Œ
        data = [
            [1, 'å¼ ä¸‰', 25, 5500.50, date(2023, 1, 15), True],
            [2, 'æå››', 30, 7200.75, date(2022, 5, 20), False],
            [3, 'ç‹äº”', 28, 6800.00, date(2023, 3, 10), True],
            [4, 'èµµå…­', 35, 9500.25, date(2021, 12, 1), False],
        ]
        
        for row_idx, row_data in enumerate(data, 2):
            for col_idx, value in enumerate(row_data, 1):
                ws.cell(row=row_idx, column=col_idx, value=value)
        
        wb.save('test_data.xlsx')
        print('Excelæµ‹è¯•æ–‡ä»¶åˆ›å»ºå®Œæˆ')
        "

    - name: æµ‹è¯•CSVè½¬SQLite
      run: |
        python XDB.py test_data.csv \
          --db-type sqlite \
          --sqlite-path csv_test.db \
          --target-table csv_data \
          --mode overwrite
        
        # éªŒè¯ç»“æœ
        python -c "
        import sqlite3
        conn = sqlite3.connect('csv_test.db')
        count = conn.execute('SELECT COUNT(*) FROM csv_data').fetchone()[0]
        print(f'CSV->SQLite: {count}è¡Œæ•°æ®')
        assert count == 4, f'æœŸæœ›4è¡Œï¼Œå®é™…{count}è¡Œ'
        
        # éªŒè¯æ•°æ®å†…å®¹
        row = conn.execute('SELECT name, age FROM csv_data WHERE id = 1').fetchone()
        assert row[0] == 'å¼ ä¸‰' and row[1] == 25, f'æ•°æ®é”™è¯¯: {row}'
        conn.close()
        print('âœ“ CSV->SQLiteæµ‹è¯•é€šè¿‡')
        "

    - name: æµ‹è¯•Excelè½¬SQLite
      run: |
        python XDB.py test_data.xlsx \
          --db-type sqlite \
          --sqlite-path excel_test.db \
          --target-table excel_data \
          --mode overwrite
        
        # éªŒè¯ç»“æœ
        python -c "
        import sqlite3
        conn = sqlite3.connect('excel_test.db')
        count = conn.execute('SELECT COUNT(*) FROM excel_data').fetchone()[0]
        print(f'Excel->SQLite: {count}è¡Œæ•°æ®')
        assert count == 4, f'æœŸæœ›4è¡Œï¼Œå®é™…{count}è¡Œ'
        
        # éªŒè¯æ•°æ®å†…å®¹
        row = conn.execute('SELECT å§“å, å¹´é¾„ FROM excel_data WHERE ID = 1').fetchone()
        assert row[0] == 'å¼ ä¸‰' and row[1] == 25, f'æ•°æ®é”™è¯¯: {row}'
        conn.close()
        print('âœ“ Excel->SQLiteæµ‹è¯•é€šè¿‡')
        "

    - name: æµ‹è¯•CSVè½¬MySQL
      run: |
        python XDB.py test_data.csv \
          --db-type mysql \
          --mysql-host 127.0.0.1 \
          --mysql-user root \
          --mysql-password testpass \
          --mysql-database testdb \
          --target-table csv_mysql_data \
          --mode overwrite
        
        # éªŒè¯ç»“æœ
        python -c "
        import pymysql
        conn = pymysql.connect(
            host='127.0.0.1', user='root', 
            password='testpass', database='testdb'
        )
        cursor = conn.cursor()
        cursor.execute('SELECT COUNT(*) FROM csv_mysql_data')
        count = cursor.fetchone()[0]
        print(f'CSV->MySQL: {count}è¡Œæ•°æ®')
        assert count == 4, f'æœŸæœ›4è¡Œï¼Œå®é™…{count}è¡Œ'
        
        # éªŒè¯æ•°æ®å†…å®¹
        cursor.execute('SELECT name, age FROM csv_mysql_data WHERE id = 1')
        row = cursor.fetchone()
        assert row[0] == 'å¼ ä¸‰' and row[1] == 25, f'æ•°æ®é”™è¯¯: {row}'
        conn.close()
        print('âœ“ CSV->MySQLæµ‹è¯•é€šè¿‡')
        "

    - name: æµ‹è¯•Excelè½¬MySQL
      run: |
        python XDB.py test_data.xlsx \
          --db-type mysql \
          --mysql-host 127.0.0.1 \
          --mysql-user root \
          --mysql-password testpass \
          --mysql-database testdb \
          --target-table excel_mysql_data \
          --mode overwrite
        
        # éªŒè¯ç»“æœ
        python -c "
        import pymysql
        conn = pymysql.connect(
            host='127.0.0.1', user='root', 
            password='testpass', database='testdb'
        )
        cursor = conn.cursor()
        cursor.execute('SELECT COUNT(*) FROM excel_mysql_data')
        count = cursor.fetchone()[0]
        print(f'Excel->MySQL: {count}è¡Œæ•°æ®')
        assert count == 4, f'æœŸæœ›4è¡Œï¼Œå®é™…{count}è¡Œ'
        
        # éªŒè¯æ•°æ®å†…å®¹
        cursor.execute('SELECT å§“å, å¹´é¾„ FROM excel_mysql_data WHERE ID = 1')
        row = cursor.fetchone()
        assert row[0] == 'å¼ ä¸‰' and row[1] == 25, f'æ•°æ®é”™è¯¯: {row}'
        conn.close()
        print('âœ“ Excel->MySQLæµ‹è¯•é€šè¿‡')
        "

    - name: æ€»ç»“
      run: echo "ğŸ‰ XDBåŸºæœ¬åŠŸèƒ½æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼"